<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>MaskPro Editor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{
      --bg:#0f1216;--panel:#14171b;--line:#232832;--muted:#9aa3ad;--txt:#eaf0f6;--blue:#2ea8ff;--btn:#1a1f26;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    .row{display:flex;align-items:center;gap:.5rem}
    .btn{background:var(--btn);border:1px solid var(--line);color:var(--txt);border-radius:8px;padding:.35rem .6rem;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .lab{opacity:.8}
    .val{opacity:.7}
    input[type="range"]{accent-color:var(--blue); flex:1;}
    .chk{display:inline-flex;align-items:center;gap:.35rem}
    .muted{color:var(--muted)}
    header#topbar{display:flex;gap:.75rem;align-items:center;padding:.55rem .75rem;border-bottom:1px solid var(--line);background:#15171b;position:sticky;top:0;z-index:20}
    #status{margin-left:auto;opacity:.8}

    main#app{display:grid;grid-template-columns:64px 1fr 8px 360px;grid-template-rows:1fr;height:calc(100vh - 50px)}
    #toolPalette{display:flex;flex-direction:column;gap:6px;background:#101317;border-right:1px solid var(--line);padding:6px}
    #toolPalette .tool{width:48px;height:48px;border-radius:10px;display:grid;place-items:center;background:#12151a;border:1px solid #1f2329;cursor:pointer}
    #toolPalette .tool.active{outline:2px solid var(--blue)}
    #toolPalette svg{width:22px;height:22px;fill:#c9d2dc}
    #eraseToggle.on{outline:2px solid #ff7373}
    #toolboxBtn.on{outline:2px solid var(--blue)}

    #center{position:relative;overflow:auto;background:#0b0d11}
    /* MODIFICATION ICI pour le centrage */
    #stageOuter{position:relative;width:100%;min-height:100%;display:flex;justify-content:center;align-items:center;transform-origin:0 0;}
    #stage{position:relative;display:inline-block; /* margin:0; -> retirÃ© pour que align-items fonctionne bien */}
    #stage canvas{display:block}
    #overlay{position:absolute;left:0;top:0;pointer-events:auto; cursor: crosshair;}

    #resizer{cursor:col-resize;background:#0d1014}
    #toolSettings{background:var(--panel);border-left:1px solid var(--line);padding:.75rem;overflow:auto}
    #toolSettings h3{margin:.75rem 0 .4rem}
    .toolcfg{display:none}
    details.group{border:1px solid var(--line);border-radius:10px;margin:.5rem 0;background:#12161c}
    details.group>summary{cursor:pointer;list-style:none;padding:.5rem .75rem;font-weight:600}
    details.group>div{padding:.5rem .75rem .75rem}
    .setting-group { margin-bottom: 1rem; }
    .setting-group .row { margin-top: 0.25rem; }
    .setting-group label { display: block; margin-bottom: 0.25rem; opacity: 0.8; }
    .setting-group input[type=number] { width: 60px; background: #0f1216; border: 1px solid var(--line); color: var(--txt); border-radius: 6px; padding: .3rem .5rem; }
    .setting-group input[type=number]:focus { outline: 1px solid var(--blue); }
    #brushGridModal{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;z-index:50}
  </style>
</head>
<body>
  <header id="topbar">
    <div class="row"><span class="lab">Zoom</span><input id="zoom" type="range" min="10" max="1000" value="100"/><span id="zoomVal" class="val">100%</span></div>
    <label class="chk" title="Toggle mask view (M)"><input id="maskOnly" type="checkbox"/> Mask Only</label>
    <button id="clear" class="btn" title="Clear the entire mask (C)">Clear Mask</button>
    <button id="clearSelection" class="btn" title="Deselect everything (Esc)">Clear Selection</button>
    <button id="fillSelection" class="btn" title="Fill the current selection (A)">Fill Selection</button>
    <button id="invert" class="btn" title="Invert the mask (I)">Invert</button>
    <button id="export" class="btn">Export</button>
    <button id="saveClose" class="btn">Save &amp; Close</button>
    <div id="status" class="muted"></div>
  </header>

  <main id="app">
    <aside id="toolPalette">
      <div id="toolboxBtn" class="tool" title="Toggle Global tools (T)"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 7V5a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2h2a2 2 0 0 1 2 2v8a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V9a2 2 0 0 1 2-2h2Zm2 0h6V5H9v2Z"/></svg></div><div id="eraseToggle" class="tool" title="Toggle erase (X)"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 16.5 12.5 7a3.536 3.536 0 0 1 5 0l1.5 1.5a3.536 3.536 0 0 1 0 5L11 20H6l-3-3.5Zm6.5 3.5H21v-2h-8l-3.5 2Z"/></svg></div>
      <div class="tool" data-tool="hand" title="Hand Tool (H)"><svg viewBox="0 0 24 24"><path d="M7 11V6a1 1 0 0 1 2 0v5h1V4a1 1 0 0 1 2 0v7h1V5a1 1 0 1 1 2 0v8h1V8a1 1 0 1 1 2 0v7a6 6 0 0 1-6 6h-2a6 6 0 0 1-6-6v-4h3z"/></svg></div>
      <div class="tool" data-tool="brush" title="Brush (B)"><svg viewBox="0 0 24 24"><path d="M7 16c-1.657 0-3 1.343-3 3 0 .552.448 1 1 1h6c0-2.209-1.791-4-4-4zm12.707-12.707a1 1 0 0 0-1.414 0l-8.5 8.5 2.414 2.414 8.5-8.5a1 1 0 0 0 0-1.414z"/></svg></div>
      <div class="tool" data-tool="lasso" title="Lasso (L)"><svg viewBox="0 0 24 24"><path d="M12 3C6.477 3 2 5.239 2 8s4.477 5 10 5 10-2.239 10-5-4.477-5-10-5zm-8 9c0 2.761 3.582 5 8 5s8-2.239 8-5"/></svg></div>
      <div class="tool" data-tool="poly" title="Polygonal lasso (K)"><svg viewBox="0 0 24 24"><path d="M3 3h6l3 6-6 12H3V3zm12 0h6v6l-9 9-3-3 6-12z"/></svg></div>
      <div class="tool" data-tool="ellipse" title="Ellipse (E)"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="7"/></svg></div>
      <div class="tool" data-tool="rect" title="Rectangle (S)"><svg viewBox="0 0 24 24"><rect x="5" y="5" width="14" height="14" rx="2"/></svg></div>
      <div class="tool" data-tool="grad" title="Gradient (G)"><svg viewBox="0 0 24 24"><defs><linearGradient id="g" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:rgb(255,255,255);stop-opacity:1"/><stop offset="100%" style="stop-color:rgb(255,255,255);stop-opacity:0"/></linearGradient></defs><rect x="4" y="4" width="16" height="16" fill="url(#g)"/></svg></div>
      <div class="tool" data-tool="wand" title="Magic wand (W)"><svg viewBox="0 0 24 24"><path d="m12 17.27 5.18 3.73-1.64-6.03L21 10.24h-6.31L12 3.98 9.31 10.24H3l5.46 4.73-1.64 6.03L12 17.27z"/></svg></div>
      <div class="tool" data-tool="zoom" title="Zoom Tool (Z)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg></div>
    </aside>

    <section class="center" id="center"><div id="stageOuter"><div id="stage"><canvas id="img"></canvas><canvas id="overlay"></canvas></div></div></section>
    <div id="resizer"></div>

    <aside id="toolSettings">
      <details id="globalTools" class="group" open>
        <summary>GLOBAL TOOLS</summary>
        <div>
          <div class="setting-group"><label for="blurSigma">Blur Contour</label><div class="row"><input id="blurSigma" type="range" min="0" max="32" step="0.5" value="3"/><input id="blurSigmaVal" type="number" min="0" max="32" step="0.5" value="3"/><button id="applyBlur" class="btn">Apply</button></div></div>
          <div class="setting-group"><label for="smoothSigma">Smooth Mask</label><div class="row"><input id="smoothSigma" type="range" min="1" max="32" value="2"/><input id="smoothSigmaVal" type="number" min="1" max="32" value="2"/><button id="applySmooth" class="btn">Apply</button></div></div>
          <div class="setting-group"><label for="imgThreshold">Image Threshold</label><div class="row"><input id="imgThreshold" type="range" min="0" max="255" value="128"/><input id="imgThresholdVal" type="number" min="0" max="255" value="128"/><button id="applyImgThreshold" class="btn">Apply</button></div></div>
          <div class="setting-group"><label for="maskThreshold">Mask Threshold</label><div class="row"><input id="maskThreshold" type="range" min="0" max="255" value="128"/><input id="maskThresholdVal" type="number" min="0" max="255" value="128"/><button id="applyMaskThreshold" class="btn">Apply</button></div></div>
          <hr style="border-color:var(--line);margin:1rem 0">
          <div class="setting-group"><label for="dilateRadius">Dilate Radius</label><div class="row"><input id="dilateRadius" type="range" min="1" max="64" value="8"/><input id="dilateVal" type="number" min="1" max="64" value="8"/><button id="applyDilate" class="btn">Apply</button></div></div>
          <div class="setting-group"><label for="erodeRadius">Contract Radius</label><div class="row"><input id="erodeRadius" type="range" min="1" max="64" value="8"/><input id="erodeVal" type="number" min="1" max="64" value="8"/><button id="applyErode" class="btn">Apply</button></div></div>
          <div class="row" style="margin-top: 1rem;"><button id="aiCutout" class="btn">AI Cutout (rembg)</button></div>
        </div>
      </details>

      <div class="toolcfg" data-toolcfg="brush">
        <h3>BRUSH</h3>
        <div class="setting-group"><label for="brush">Size</label><div class="row"><input id="brush" type="range" min="1" max="2048" value="60"/><input id="brushVal" type="number" min="1" max="2048" value="60"/></div></div>
        <div class="setting-group"><label for="hard">Hardness</label><div class="row"><input id="hard" type="range" min="0" max="100" value="80"/><input id="hardVal" type="number" min="0" max="100" value="80"/></div></div>
        <div class="setting-group"><label for="opacity">Opacity</label><div class="row"><input id="opacity" type="range" min="1" max="100" value="100"/><input id="opacityVal" type="number" min="1" max="100" value="100"/></div></div>
        <div class="setting-group"><label for="smooth">Smoothing</label><div class="row"><input id="smooth" type="range" min="0" max="100" value="20"/><input id="smoothVal" type="number" min="0" max="100" value="20"/></div></div>
        <div class="setting-group"><label for="brushSpacing">Spacing (Pas)</label><div class="row"><input id="brushSpacing" type="range" min="1" max="200" value="1"/><input id="brushSpacingVal" type="number" min="1" max="200" value="1"/></div></div>
        <div class="row" style="margin-top: 1rem;"><span class="lab">Shape</span>
          <label class="chk"><input type="radio" name="bshape" id="brushShapeRound" checked/> Round</label>
          <label class="chk"><input type="radio" name="bshape" id="brushShapeSquare"/> Square</label>
          <label class="chk"><input type="radio" name="bshape" id="brushShapeCustom"/> Custom</label>
        </div>
        <div class="row" id="customBrushRow" style="display:none"><span class="lab">In /web/brushes :</span><select id="customBrushList"></select><button id="reloadBrushes" class="btn">Reload</button></div>
        <div class="row" id="customBrushRow2" style="display:none"><span class="lab">or file name:</span><input id="customBrushName" type="text" placeholder="mybrush.png" style="flex:1;min-width:160px;background:#0f1216;border:1px solid var(--line);color:var(--txt);border-radius:6px;padding:.3rem .5rem"/><button id="loadBrush" class="btn">Load</button></div>
        <div class="row" id="customBrushRow3" style="display:none"><span class="lab">Rotation</span><input id="customRot" type="range" min="0" max="360" value="0"/><span id="customRotVal" class="val">0Â°</span></div>
        <div class="row" id="customBrushRowPicker" style="display:none"><button id="openBrushGrid" class="btn">Open brush grid</button></div>
      </div>

      <div class="toolcfg" data-toolcfg="lasso"><h3>LASSO</h3><div class="setting-group"><label for="lassoFeather">Blur contour</label><div class="row"><input id="lassoFeather" type="range" min="0" max="32" step="0.5" value="0"/><input id="lassoFeatherVal" type="number" min="0" max="32" step="0.5" value="0"/></div></div><label class="chk"><input id="lassoAutofill" type="checkbox"/> Autofill</label></div>
      <div class="toolcfg" data-toolcfg="poly"><h3>POLYGONAL LASSO</h3><div class="setting-group"><label for="polyFeather">Blur contour</label><div class="row"><input id="polyFeather" type="range" min="0" max="32" step="0.5" value="0"/><input id="polyFeatherVal" type="number" min="0" max="32" step="0.5" value="0"/></div></div><label class="chk"><input id="polyAutofill" type="checkbox"/> Autofill</label><div class="muted">Left-click = point â¢ Right-click or Alt = close â¢ Esc = cancel</div></div>
      <div class="toolcfg" data-toolcfg="ellipse"><h3>ELLIPSE / CIRCLE</h3><div class="setting-group"><label for="ellFeather">Blur contour</label><div class="row"><input id="ellFeather" type="range" min="0" max="32" step="0.5" value="0"/><input id="ellFeatherVal" type="number" min="0" max="32" step="0.5" value="0"/></div></div><label class="chk"><input id="ellCenter" type="checkbox"/> Center origin (Alt)</label><label class="chk"><input id="ellAutofill" type="checkbox"/> Autofill</label><div class="muted">Hold Ctrl for perfect circle</div></div>
      <div class="toolcfg" data-toolcfg="rect"><h3>RECTANGLE / SQUARE</h3><div class="setting-group"><label for="rectFeather">Blur contour</label><div class="row"><input id="rectFeather" type="range" min="0" max="32" step="0.5" value="0"/><input id="rectFeatherVal" type="number" min="0" max="32" step="0.5" value="0"/></div></div><div class="setting-group"><label for="rectRadius">Corner radius</label><div class="row"><input id="rectRadius" type="range" min="0" max="64" value="0"/><input id="rectRadiusVal" type="number" min="0" max="64" value="0"/></div></div><label class="chk"><input id="rectCenter" type="checkbox"/> Center origin (Alt)</label><label class="chk"><input id="rectAutofill" type="checkbox"/> Autofill</label><div class="muted">Hold Ctrl for perfect square</div></div>
      <div class="toolcfg" data-toolcfg="grad"><h3>GRADIENT</h3><label class="chk"><input id="gradRadial" type="checkbox"/> Radial</label><div class="setting-group"><label for="gradOpacity">Opacity</label><div class="row"><input id="gradOpacity" type="range" min="1" max="100" value="100"/><input id="gradOpacityVal" type="number" min="1" max="100" value="100"/></div></div><div class="muted">Fills from solid â transparent along the line.</div></div>
      <div class="toolcfg" data-toolcfg="wand"><h3>MAGIC WAND</h3><div class="row" style="margin-bottom: 1rem;"><span class="lab">Mode</span><label class="chk"><input type="radio" name="wandMode" id="wandAdd" checked/> + Add</label><label class="chk"><input type="radio" name="wandMode" id="wandSub"/> â Subtract</label></div><div class="setting-group"><label for="wandTol">Tolerance</label><div class="row"><input id="wandTol" type="range" min="0" max="255" value="32"/><input id="wandTolVal" type="number" min="0" max="255" value="32"/></div></div><div class="setting-group"><label for="wandSmooth">Smoothing</label><div class="row"><input id="wandSmooth" type="range" min="0" max="40" value="6"/><input id="wandSmoothVal" type="number" min="0" max="40" value="6"/></div></div><div class="setting-group"><label for="wandAvg">Average</label><div class="row"><input id="wandAvg" type="range" min="3" max="101" step="2" value="3"/><input id="wandAvgVal" type="number" min="3" max="101" step="2" value="3"/></div></div></div>
    </aside>
  </main>
  <div id="brushGridModal"><div style="background:#14171b;border:1px solid #232832;border-radius:12px;max-width:80vw;max-height:80vh;display:flex;flex-direction:column;gap:.5rem;padding:.75rem"><div style="display:flex;gap:.5rem;align-items:center"><strong style="flex:1">Custom brushes</strong><button id="brushGridRefresh" class="btn">Refresh</button><button id="brushGridClose" class="btn">Close</button></div><div id="brushGrid" style="display:grid;grid-template-columns:repeat(auto-fill,120px);gap:.75rem;overflow:auto;padding:.25rem;min-width:480px;min-height:320px"></div></div></div>
  <script src="editor.js"></script>
</body>
</html>